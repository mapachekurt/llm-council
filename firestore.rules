rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // NOTE: These rules allow client-side reads for development purposes.
    // In production, you should either:
    // 1. Integrate Clerk with Firebase Auth using custom tokens
    // 2. Proxy all database operations through Firebase Functions

    // For now, we're using a simplified approach:
    // - Writes are handled by Firebase Functions (Admin SDK)
    // - Reads are allowed based on userId field matching
    // - This is NOT secure without proper authentication integration

    match /conversations/{conversationId} {
      // Allow reads if the conversation belongs to the user
      // Note: This relies on the client passing a valid userId
      // which is NOT secure without Firebase Auth integration
      allow read: if true;  // DEVELOPMENT ONLY - see note above

      // Writes are handled by Firebase Functions with Admin SDK
      // Direct client writes are not allowed
      allow write: if false;

      match /messages/{messageId} {
        // Allow reads for messages in conversations
        // Same security caveat as above
        allow read: if true;  // DEVELOPMENT ONLY - see note above

        // Writes are handled by Firebase Functions
        allow write: if false;
      }
    }

    // TODO: For production deployment, implement one of these approaches:
    //
    // Option 1: Integrate Clerk with Firebase Auth
    // - Use Clerk's Firebase integration to create custom tokens
    // - Replace "true" above with proper auth checks:
    //   allow read: if request.auth != null &&
    //     get(/databases/$(database)/documents/conversations/$(conversationId)).data.userId == request.auth.uid;
    //
    // Option 2: Proxy all reads through Firebase Functions
    // - Add new functions for getConversations and getMessages
    // - Verify Clerk tokens in those functions
    // - Keep these rules as "allow read: if false"

    // Default deny: For any path not matched above, access is denied.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
